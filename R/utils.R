#' Run \href{https://sourceforge.net/p/mageck/wiki/Home/}{MAGeCK} with given simulation data
#'
#' @param dat a \code{data.frame} was generated by \href{crispulator.ucsf.edu}{CRISPulator}
#'
#' @return The two \code{data.frame} of statistics for each sgRNA and each gene
#' @export
#'
#' @examples
#' library(CRISPRCloud2)
#' dat <- read.csv("https://raw.githubusercontent.com/hyunhwaj/Crispulator.jl/master/simulation/matrix/scenario_4_0.1_0.5_0.2.csv")
#' run.mageck(dat)
run.mageck <- function(dat) {
  tmp.fname <- tempfile(pattern = "file", tmpdir = tempdir())

  dat.mageck <- dat[, c(3,2, 5:ncol(dat))]
  write.table(file = tmp.fname, dat.mageck, sep="\t", quote = F, row.names = F)
  mageck.cmd <- "mageck"

  nx <- ncol(dat)-4
  control.samples <- colnames(dat)[5:(5+nx/2-1)]
  case.samples <- colnames(dat)[(5+nx/2):(5+nx-1)]

  treatment.id <- paste0( case.samples, collapse="," )
  control.id <- paste0( control.samples, collapse="," )

  out.dir <- paste0(tempdir(),"/", "mageck")
  cmd  <- paste(mageck.cmd, "test", "-k", tmp.fname, "-t", treatment.id, "-c", control.id,
                "-n", out.dir)

  system(cmd)
  df.gene <- read.table(paste0(out.dir, ".gene_summary.txt"),
                        sep="\t", row.names = NULL, head=T) %>%
    mutate(pvalue=pmin(1,pmin(neg.p.value, pos.p.value)*2)) %>%
    select(gene=id, pvalue=pvalue)


  df.sgRNA <- read.table(paste0(out.dir, ".sgrna_summary.txt"),
                         sep="\t", row.names = NULL, head=T) %>%
    select(sgRNA=sgrna, pvalue=p.twosided)
  list("gene"=df.gene, "sgRNA"=df.sgRNA)
}

#' Run mbttest with given simulation data
#'
#' @param data \code{data.frame} was generated by \href{crispulator.ucsf.edu}{CRISPulator}
#'
#' @return The two \code{data.frame} of statistics for each sgRNA and each gene
#' @export
#'
#' @examples
#' library(CRISPRCloud2)
#' dat <- read.csv("https://raw.githubusercontent.com/hyunhwaj/Crispulator.jl/master/simulation/matrix/scenario_4_0.1_0.5_0.2.csv")
#' run.mbttest(dat)
run.mbttest <- function(dat) {
  nx <- (ncol(dat)-4)
  df.sgRNA <- mbetattest(X=dat, nci=4, na=nx/2, nb=nx/2, alpha=0.05, level="sgRNA") %>%
    dplyr::select(sgRNA=sgRNA, pvalue=pvalue)
  df.gene <- mbetattest(X=dat, nci=4, na=nx/2, nb=nx/2, alpha=0.05, level="gene") %>%
    dplyr::select(gene=genes, pvalue=gpvalue)
  list("gene"=df.gene, "sgRNA"=df.sgRNA)
}


run.DESeq2<-function(dat){
  df.deseq2<-dat[,-(1:4)]

  nx <- ncol(df.deseq2)
  col.data <- data.frame(row.names = colnames(df.deseq2),
                         condition=c(rep("T0", nx/2),rep("T1", nx/2)))
  col.data$condition <- factor(col.data$condition, levels = c("T0", "T1"))

  row.names(df.deseq2)<-dat$sgRNA

  dds <- DESeqDataSetFromMatrix(countData = df.deseq2, colData = col.data, design = ~ condition)
  dds <- DESeq(dds)
  res <- as.data.frame(results(dds))
  list("sgRNA"=data.frame(sgRNA=rownames(res), pvalue=res$pvalue))
}

run.edgeR <- function(dat) {
  df.edgeR <-dat[,-(1:4)]
  nx <- ncol(df.edgeR)
  group <- c(rep("T0", nx/2),rep("T1", nx/2))
  res1<- DGEList(counts=df.edgeR, group=group)
  res2<- estimateCommonDisp(res1)
  res3<- estimateTagwiseDisp(res2)
  res4<- exactTest(res3)
  list("sgRNA"=data.frame(sgRNA=dat$sgRNA, pvalue=res4$table$PValue))
}

run.ScreenBEAM <- function(dat) {
  nx <- ncol(dat)-4
  control.samples <- colnames(dat)[5:(5+nx/2-1)]
  case.samples <- colnames(dat)[(5+nx/2):(5+nx-1)]
  tmp.name <- tempfile()
  write.table(dat, file=tmp.name, sep="\t")
  df.ret <- ScreenBEAM(
    ###input format
    input.file = tmp.name,
    control.samples = control.samples, case.samples = case.samples,
    control.groupname = 'LOW', case.groupname = 'HIGH',
    data.type = 'NGS',
    do.normalization = TRUE,
    filterLowCount = FALSE,
    filterBy = 'control',
    gene.columnId = 2,
    nitt = 15000,
    burnin = 5000
  )
  df.gene <- data.frame(gene=df.ret$gene, pvalue=df.ret[,6])
  list("gene"=df.gene)
}

run.sgRSEA <- function(dat) {
  nx <- ncol(dat)-4
  control.samples <- colnames(dat)[5:(5+nx/2-1)]
  case.samples <- colnames(dat)[(5+nx/2):(5+nx-1)]

  dat <- UQnormalize(dat, trt=case.samples, ctrl=control.samples)
  results <- sgRSEA(dat=dat, multiplier=30)

  pos <- data.frame(gene=row.names(results$gene.pos),  pvalue=results$gene.pos[,3])
  neg <- data.frame(gene=row.names(results$gene.neg),  pvalue=results$gene.neg[,3])

  ret <- list("gene"=as.data.frame(dplyr::left_join(pos, neg, by="gene") %>%
         dplyr::mutate(pvalue=pmin(1,pmin(pvalue.x, pvalue.y)*2)) %>%
         dplyr::select(gene=gene, pvalue=pvalue)))
  ret
}

#' Load a simulation file from \href{https://github.com/hyunhwaj/Crispulator.jl}{hyunhwaj/Crispulator.jl}
#'
#' @param depth sequencing depth
#' @param facs bin ratio of FACS
#' @param noise noise ratio
#' @param effect effect size (proportion of negative/positive phenotype)
#'
#' @return
#' @export
#'
#' @examples
#' library(CRISPRCloud2)
#' dat <- load.sim(facs=0.1, noise=1.0, effect=0.4)
#' df.ret <- mbetattest(X=dat, nci=4, na=4, nb=4, alpha=0.05)
load.sim <- function(depth, facs, noise, effect) {
  raw.url <- "https://raw.githubusercontent.com/hyunhwaj/Crispulator.jl/master/simulation/matrix/scenario_%d_%.2f_%.2f_%.2f.csv"
  url <- sprintf(raw.url, depth, facs, noise, effect)
  read.csv(url)
}

#' Load a tiny simulation file
#'
#' @return a data frame of a simulated data with $200$ sgRNAs
#' @export
#'
#' @examples
#' dat <- load.sample()
#' head(dat)
load.sample <- function() {
  raw.url <- "https://raw.githubusercontent.com/hyunhwaj/Crispulator.jl/master/simulation/matrix/scenario_1000_0.10_1.00_0.20.csv"
  read.csv(raw.url)[1:200,]
}
